# Stage 1: Build
FROM node:20-alpine as build

WORKDIR /app

# Copy package files and install dependencies
COPY package*.json ./
RUN npm install --force

# Install Expo CLI globally
RUN npm install -g expo

# Install ngrok globally to avoid interactive prompts during `expo start`
RUN npm install -g @expo/ngrok

# Copy the rest of the application
COPY . .

# Stage 2: Production
FROM node:20-alpine

WORKDIR /app

# Copy the application from the build stage
COPY --from=build /app .

# Install Expo CLI and ngrok globally again in the production image
RUN npm install -g expo
RUN npm install -g @expo/ngrok

# Set CI environment variable for non-interactive mode
ENV CI=1

EXPOSE 8081
EXPOSE 19000
EXPOSE 19001

# Run Expo start with the tunnel
CMD ["expo", "start", "--lan", "--no-dev", "--minify"]


